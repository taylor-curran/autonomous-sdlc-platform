# Autonomous SDLC Pipeline — Reusable Workflow
name: Autonomous SDLC Pipeline

on:
  workflow_call:
    inputs:
      sonar_org:
        description: 'SonarCloud organization key'
        type: string
        default: 'taylor-curran'

jobs:
  sonarcloud:
    name: SonarCloud Scan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # full history needed for SonarCloud new code detection

      - name: Create empty classes dir
        run: mkdir -p /tmp/empty-classes

      - name: SonarCloud Scan
        uses: SonarSource/sonarqube-scan-action@v5
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        with:
          args: >
            -Dsonar.organization=${{ inputs.sonar_org }}
            -Dsonar.projectKey=${{ inputs.sonar_org }}_${{ github.event.repository.name }}
            -Dsonar.host.url=https://sonarcloud.io
            -Dsonar.java.binaries=/tmp/empty-classes

      - name: Check Quality Gate
        id: quality_gate
        uses: SonarSource/sonarqube-quality-gate-action@v1
        timeout-minutes: 5
        continue-on-error: true
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

      - name: Launch Devin (Fix Issues)
        if: steps.quality_gate.outcome == 'failure'
        env:
          DEVIN_API_KEY: ${{ secrets.DEVIN_API_KEY }}
          DEVIN_ORG_ID: ${{ secrets.DEVIN_ORG_ID }}
        run: |
          PROJECT_KEY="${{ inputs.sonar_org }}_${{ github.event.repository.name }}"
          REPO="${{ github.repository }}"

          PROMPT="The SonarCloud quality gate failed for project ${PROJECT_KEY} (repo: ${REPO}). Use the SonarCloud MCP to fetch the open issues for this project, prioritized by severity. Create one child session per issue — each child session should fix a single issue and open a PR. Use the !single_sonarqube playbook for each child session."

          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
            "https://api.devin.ai/v3beta1/organizations/${DEVIN_ORG_ID}/sessions" \
            -H "Authorization: Bearer ${DEVIN_API_KEY}" \
            -H "Content-Type: application/json" \
            -d "$(jq -n \
              --arg prompt "$PROMPT" \
              --arg repo "$REPO" \
              --arg title "Fix SonarQube Issues — ${REPO}" \
              '{
                prompt: $prompt,
                advanced_mode: "batch",
                bypass_approval: true,
                child_playbook_id: "ab9401b86aa0492bb3501f64f22b85f0",
                repos: [$repo],
                title: $title,
                tags: ["sonarqube", "auto-fix"]
              }')")

          HTTP_CODE=$(echo "$RESPONSE" | tail -1)
          BODY=$(echo "$RESPONSE" | sed '$d')

          if [ "$HTTP_CODE" -ge 200 ] && [ "$HTTP_CODE" -lt 300 ]; then
            SESSION_ID=$(echo "$BODY" | jq -r '.session_id')
            SESSION_URL=$(echo "$BODY" | jq -r '.url')
            echo "✅ Devin batch session created"
            echo "   Session: ${SESSION_ID}"
            echo "   URL:     ${SESSION_URL}"
          else
            echo "❌ Failed to create Devin session (HTTP ${HTTP_CODE})"
            echo "$BODY"
            exit 1
          fi
